/*** Insert and update code ***/
USE FDDBA
GO
INSERT INTO dbo.agentjob_monitor(job_id, is_enabled, report_success, job_name, retention_days, insert_date)
select
j.job_id
,1
,0
,j.name
,30
,GETDATE()
FROM
msdb.dbo.sysjobs j
INNER JOIN msdb.dbo.syscategories c on j.category_id = c.category_id
AND c.name LIKE 'Fortified Data%'
WHERE
j.job_id not in(select job_id from dbo.agentjob_monitor where is_enabled = 1)

update FDDBA.dbo.agentjob_monitor set retention_days = 5
where job_name in(N'DatabaseBackup - USER_DATABASES - LOG', N'FD - Capture Perfmon Data', N'FD - ExecRequest Load', N'FD - GatherWaitStatistics',
N'FD - Monitor - Open transactions from V5HanlderUser', N'FD - Monitor Schedulers', N'FD - Run Operations', N'FD - WhoIsActive Load')

update FDDBA.dbo.agentjob_monitor set retention_days = 7
where job_name in(N'DatabaseBackup - USER_DATABASES - DIFF')

update FDDBA.dbo.agentjob_monitor set retention_days = 60
where job_name in(N'CommandLog Cleanup',N'Output File Cleanup', N'sp_delete_backuphistory', N'sp_purge_jobhistory', N'sp_purge_jobhistory')

update FDDBA.dbo.agentjob_monitor set retention_days = 45
where job_name in(N'DatabaseBackup - SYSTEM_DATABASES - FULL',N'DatabaseBackup - USER_DATABASES - FULL',N'DatabaseIntegrityCheck - SYSTEM_DATABASES',
N'DatabaseIntegrityCheck - USER_DATABASES',N'IndexOptimize - ALL_DATABASES')

/*** JOB CHECKING CODE ***/
If not exists(select * from msdb.dbo.sysjobs where name = N'FD - Monitor Agent Job History')
RAISERROR('Job [FD - Monitor Agent Job History] is missing. Please add it.',15,1) with nowait;
else
begin
If exists(select * from msdb.dbo.sysjobs where name = N'FD - Monitor Agent Job History' and enabled = 0)
begin
RAISERROR('Job [FD - Monitor Agent Job History] is not enabled. Runing enable code now.',15,1) with nowait;
exec msdb.dbo.sp_update_job @job_name = N'FD - Monitor Agent Job History', @enabled = 1
end
If not exists(select * from msdb.dbo.sysjobs j inner join msdb.dbo.sysjobschedules s on j.job_id = s.job_id
inner join msdb.dbo.sysschedules sc on s.schedule_id = sc.schedule_id and sc.enabled = 1 where j.name = N'FD - Monitor Agent Job History' )
RAISERROR('Job [FD - Monitor Agent Job History] does not have a schedule or has a disabled schedule. Please schedule the job to run every 10 mintues.',15,1) with nowait;

end

If not exists(select * from msdb.dbo.sysjobs where name = N'FD - Monitor Agent Job History Purge')
RAISERROR('Job [FD - Monitor Agent Job History Purge] is missing. Please add it.',15,1) with nowait;
else
begin
If exists(select * from msdb.dbo.sysjobs where name = N'FD - Monitor Agent Job History Purge' and enabled = 0)
begin
RAISERROR('Job [FD - Monitor Agent Job History Purge] is not enabled. Runing enable code now.',15,1) with nowait;
exec msdb.dbo.sp_update_job @job_name = N'FD - Monitor Agent Job History Purge', @enabled = 1
end
If not exists(select * from msdb.dbo.sysjobs j inner join msdb.dbo.sysjobschedules s on j.job_id = s.job_id
inner join msdb.dbo.sysschedules sc on s.schedule_id = sc.schedule_id and sc.enabled = 1 where j.name = N'FD - Monitor Agent Job History Purge' )
RAISERROR('Job [FD - Monitor Agent Job History Purge] does not have a schedule or has a disabled schedule. Please schedule the job to run every 10 mintues.',15,1) with nowait;
end
